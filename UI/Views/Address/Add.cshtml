
@{
    ViewData["Title"] = "Add";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Css{
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0
    /dist/L.Control.Locate.min.js" charset="utf-8"></script>

    <style>
        #map{
            height : 200px;
        }
    </style>
}

<div class="checkout woocommerce-checkout">
    <div class="content-checkout container">
        <div class="middle-container">
            <div  class="form-checkout">
                <div class="col2-set" id="customer-details">
                    <div class="col-12">
                        <div class="billing-fields mt-4">
                            <h4>افزودن آدرس جدید</h4>
                            <div class="form-checkout-row">
                                <div>
                                    <label for="name">استان <abbr class="required" title="ضروری" style="color:red;">*</abbr></label>
                                    <input type="text" id="State" class="input-name-checkout form-control">
                                </div>

                                <div>
                                    <label for="name">شهر <abbr class="required" title="ضروری" style="color:red;">*</abbr></label>
                                    <input type="text" id="City" class="input-name-checkout form-control">
                                </div>

                                <div>
                                    <label for="phone-number">شماره موبایل <abbr class="required" title="ضروری" style="color:red;">*</abbr></label>
                                    <input type="text" id="phone-number" class="input-name-checkout form-control text-left">
                                </div>

                                <div>
                                    <label for="post-code">کد پستی <abbr class="required" title="ضروری" style="color:red;">*</abbr></label>
                                    <input type="text" id="post-code" class="input-name-checkout form-control" placeholder="کد پستی را بدون خط تیره بنویسید">
                                </div>

                                <div>
                                    <label for="Street">آدرس <abbr class="required" title="ضروری" style="color:red;">*</abbr></label>
                                    <input type="text" id="Address" class="input-name-checkout form-control">
                                </div>
                                <div class="d-block">
                                    <label for="Street">انتخاب آدرس روی نقشه <abbr class="required" title="ضروری" style="color:red;">*</abbr></label>
                                    <div class="col-12 col-md-3" id="map"></div>
                                </div>
                                <div class="d-flex justify-content-center align-items-center">
                                    <button onclick="Submit()" class="btn btn-success px-3">ثبت</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


@section Script{
    <link href="~/assets/Sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <script src="~/assets/Sweetalert2/sweetalert2.min.js"></script>
    <script>
        var lat = "", lng = ""
        var map = L.map('map').setView([35.7219, 51.3347], 13);


        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        L.control.locate().addTo(map)



        var marker = L.marker([35.7219, 51.3347]).addTo(map)
            .bindPopup('لطفا روی نقشه ادرس خودرا انتخاب کنید')
            .openPopup();

        map.on('locationfound', function (ev) {
            marker.setLatLng(ev.latlng);
        })

        map.on('click', function (e) {
            if (marker)
                map.removeLayer(marker);
            //console.log(e.latlng.lat); // e is an event object (MouseEvent in this case)
            lat = e.latlng.lat
            lng = e.latlng.lng
            marker = L.marker(e.latlng).addTo(map);
        });


        
        function Submit() {
            const xhr = new XMLHttpRequest();
            // Initialize the request
            xhr.open("POST", '/Address/Add');
            // Set content type
            xhr.setRequestHeader('Content-type', 'application/json; charset=UTF-8');
            // Send the request with data to post
            xhr.send(
                JSON.stringify({
                    City : document.getElementById("City").value,
                    PostalCode: document.getElementById("post-code").value,
                    Phone: document.getElementById("phone-number").value,
                    Latitude : lat.toString(),
                    Longitude : lng.toString(),
                    address: document.getElementById("Address").value,
                    State: document.getElementById("State").value,
                })
            );

            xhr.onload = function (e) {
                // Check if the request was a success
                if (this.readyState === XMLHttpRequest.DONE) {
                    // Get and convert the responseText into JSON
                    let response = JSON.parse(xhr.responseText)
                    if (response.isSuccess == false) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطا',
                            text: response.message
                        })
                    }
                    else {
                        Swal.fire(
                            'موفق',
                            'آدرس جدید افزوده شد',
                            'success'
                        ).then(() => {
                            document.location = "/order"
                        })

                    }
                }
            }
        }
    </script>
}